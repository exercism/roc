#!/usr/bin/env bash

# Synopsis:
# Test the track's exercises.
# 
# At a minimum, this file must check if the example/exemplar solution of each 
# Practice/Concept Exercise passes the exercise's tests.
#
# To check this, you usually have to (temporarily) replace the exercise's solution files
# with its exemplar/example files.
#
# If your track uses skipped tests, make sure to (temporarily) enable these tests
# before running the tests.
#
# The path to the solution/example/exemplar files can be found in the exercise's
# .meta/config.json file, or possibly inferred from the exercise's directory name.

# Example: verify all exercises
# ./bin/verify-exercises

# Example: verify single exercise
# ./bin/verify-exercises two-fer

slug="${1:-*}"

test_example() {
    MODULE_FILE=`jq -r '.files.solution[]' $1/.meta/config.json`
    EXAMPLE_FILE=`jq -r '.files.example[]' $1/.meta/config.json`
    TEST_FILE=`jq -r '.files.test[]' $1/.meta/config.json`
    mv "$1/${MODULE_FILE}" "$1/${MODULE_FILE}.bak"
    cp "$1/${EXAMPLE_FILE}" "$1/${MODULE_FILE}"
    roc test "$1/${TEST_FILE}"
    mv -f "$1/${MODULE_FILE}".bak "$1/${MODULE_FILE}"
}

# Verify the Concept Exercises
for concept_exercise_dir in ./exercises/concept/${slug}/; do
    if [ -d $concept_exercise_dir ]; then
        echo "Checking $(basename "${concept_exercise_dir}") exercise..."
        test_example "${concept_exercise_dir%/}"
    fi
done

# Verify the Practice Exercises
for practice_exercise_dir in ./exercises/practice/${slug}/; do
    if [ -d $practice_exercise_dir ]; then
        echo "Checking $(basename "${practice_exercise_dir}") exercise..."
        test_example "${practice_exercise_dir%/}"
    fi
done
